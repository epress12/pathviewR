---
title: "Basics of data import and cleaning in pathviewR"
author: "Vikram B. Baliga"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basics of data import and cleaning in pathviewR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Data import via `pathviewR`

We presently support `.csv` files exported from Optitrack's Motive software
(link) as well as `.mat` files exported from Flydra (link).

We'll start by loading `pathviewR`

```{r package_loading, message=FALSE, warning=FALSE}
## If you do not already have pathviewR installed:
# install.packages("devtools")
# devtools::install_github("vbaliga/pathviewR")

library(pathviewR)
```

### Motive CSV files

`.csv` files exported from Motive can be imported via `read_motive_csv()`

```{r import_motive}
## Import the july 29 example data included in 
## the package
motive_data <-
  read_motive_csv(
    system.file("extdata", "july-29_group-I_16-20.csv",
                package = 'pathviewR')
  )
## This produces a tibble 
motive_data
``` 

Important metadata are stored as attributes. We won't go through all of these,
but here are a couple important ones.

``` {r metadata}
## E.g. to see the header of the original file:
attr(motive_data, "header")

## Names of all marked objects:
attr(motive_data, "subject_names_simple")

## Types of data included
attr(motive_data, "data_types_simple")

## Frame rate
attr(motive_data, "frame_rate")
```

### Flydra Matlab files

`.mat` files exported from Flydra can be imported via `read_flydra_mat()`.

Note that a subject name is required. Only one name can be added and it will
be used throughout the resultant `tibble`.

```{r import_flydra}
## Import the Flydra example data included in 
## the package
flydra_data <-
  read_flydra_mat(
    system.file("extdata/roz2016/", 
                "DATA20160619_125218.kalmanized.h5-short-only.mat",
                package = 'pathviewR'),
    subject_name = "bird"
  )

## Similarly, this produces a tibble with important 
## metadata as attributes
flydra_data
```

## Data cleaning
Data exported via either Motive or Flydra are not typically "tidy". Functions in
`pathviewR` ultimately rely on having tidy data sets that are easily 
interpreted.

Several functions to clean and wrangle data are available, and we have a
suggested pipeline for how these steps should be handled.

And speaking of pipes, all functions in `pathviewR` are pipe-friendly. We will
detail each step separately, but each of the subsequent steps may be piped, e.g.
`data %>% relabel_viewr_axes() %>% gather_tunnel_data()` etc etc

### Relabeling axes, gathering data columns, and trimming outliers
Axis labels (x, y, z) may be applied in abitrary ways by software. A user might
intuitively think the z axis represents height, but the original software may
label it as the y axis instead.

`relabel_viewr_axes` provides a means to relabel axes with  "tunnel_length",
"tunnel_width", and "tunnel_height". **These axis labels will be expected by
subsequent funtions, so skipping this step is ill-advised.**

```{r relabel_axes}
motive_relabeled <-
  motive_data %>%
  relabel_viewr_axes(
    tunnel_length = "_z",
    tunnel_width = "_x",
    tunnel_height = "_y",
    real = "_w"
  )
names(motive_relabeled)
```

Akin to the behavior of `dplyr::gather()`, `gather_tunnel_data()` will take all
data from a given session and organize it so that all data of a given type are
within one column, i.e. all position lengths are in `Position_length`, as
opposed to separate length columns for each rigid body. **These column names
will be expected by subsequent funtions, so skipping this step is also
ill-advised.**

Use `trim_tunnel_outliers()` to remove artifacts and other outlier data. This
step is entirely optional, and really should be used when the user is confident
that data outside certain ranges are artifacts or other bugs. Data ouside these
ranges are filtered out. Best to plot data beforehand and check!!

```{r gather_and_trim}
## First gather and show the new column names
motive_gathered <-
  motive_relabeled %>%
  gather_tunnel_data()
names(motive_gathered)

## Now trim, using ranges we know to safely include data
## and exclude artifacts. Anything outside these ranges 
## will be removed.
motive_trimmed <-
  motive_gathered %>%
  trim_tunnel_outliers(
    lengths_min = 0,
    lengths_max = 3,
    widths_min = -0.4,
    widths_max = 0.8,
    heights_min = -0.2,
    heights_max = 0.5
  )
```

Next sections TBD: 
1) rotate vs. standardize vs. redefine center
2) select x percent 
3) separate trajectories (and link to another vignette)
4) get full trajectories
