---
title: "Basics of data import and cleaning in pathviewR"
author: "Vikram B. Baliga"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basics of data import and cleaning in pathviewR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Data import via `pathviewR`

We presently support `.csv` files exported from Optitrack's Motive software
(link) as well as `.mat` files exported from Flydra (link).

We'll start by loading `pathviewR`

```{r package_loading, message=FALSE, warning=FALSE}
## If you do not already have pathviewR installed:
# install.packages("devtools")
# devtools::install_github("vbaliga/pathviewR")

library(pathviewR)
```

### Motive CSV files

`.csv` files exported from Motive can be imported via `read_motive_csv()`

```{r import_motive}
## Import the july 29 example data included in 
## the package
motive_data <-
  read_motive_csv(
    system.file("extdata", "july-29_group-I_16-20.csv",
                package = 'pathviewR')
  )

## This produces a tibble 
motive_data
``` 

Important metadata are stored as attributes. We won't go through all of these,
but here are a couple important ones.

``` {r metadata}
## E.g. to see the header of the original file:
attr(motive_data, "header")

## Names of all marked objects:
attr(motive_data, "subject_names_simple")

## Types of data included
attr(motive_data, "data_types_simple")

## Frame rate
attr(motive_data, "frame_rate")
```

### Flydra Matlab files

`.mat` files exported from Flydra can be imported via `read_flydra_mat()`.

Note that a subject name is required. Only one name can be added and it will
be used throughout the resultant `tibble`.

```{r import_flydra}
## Import the Flydra example data included in 
## the package
flydra_data <-
  read_flydra_mat(
    system.file("extdata/roz2016/", 
                "DATA20160619_125218.kalmanized.h5-short-only.mat",
                package = 'pathviewR'),
    subject_name = "bird"
  )

## Similarly, this produces a tibble with important 
## metadata as attributes
flydra_data
```

## Data cleaning
Data exported via either Motive or Flydra are not typically "tidy". Functions in
`pathviewR` ultimately rely on having tidy data sets that are easily 
interpreted.

Several functions to clean and wrangle data are available, and we have a
suggested pipeline for how these steps should be handled.

And speaking of pipes, all functions in `pathviewR` are pipe-friendly. We will
detail each step separately, but each of the subsequent steps may be piped, e.g.
`data %>% relabel_viewr_axes() %>% gather_tunnel_data()` etc etc

### Relabeling axes, gathering data columns, and trimming outliers
Axis labels (x, y, z) may be applied in abitrary ways by software. A user might
intuitively think the z axis represents height, but the original software may
label it as the y axis instead.

`relabel_viewr_axes` provides a means to relabel axes with  "tunnel_length",
"tunnel_width", and "tunnel_height". **These axis labels will be expected by
subsequent funtions, so skipping this step is ill-advised.**

```{r relabel_axes}
motive_relabeled <-
  motive_data %>%
  relabel_viewr_axes(
    tunnel_length = "_z",
    tunnel_width = "_x",
    tunnel_height = "_y",
    real = "_w"
  )

names(motive_relabeled)
```

Akin to the behavior of `dplyr::gather()`, `gather_tunnel_data()` will take all
data from a given session and organize it so that all data of a given type are
within one column, i.e. all position lengths are in `Position_length`, as
opposed to separate length columns for each rigid body. **These column names
will be expected by subsequent funtions, so skipping this step is also
ill-advised.**

Use `trim_tunnel_outliers()` to remove artifacts and other outlier data. This
step is entirely optional, and should only be used when the user is confident
that data outside certain ranges are artifacts or other bugs. Data ouside these
ranges are then filtered out. Best to plot data beforehand and check!!

```{r gather_and_trim}
## First gather and show the new column names
motive_gathered <-
  motive_relabeled %>%
  gather_tunnel_data()

names(motive_gathered)

## Now trim, using ranges we know to safely include data
## and exclude artifacts. Anything outside these ranges 
## will be removed.
motive_trimmed <-
  motive_gathered %>%
  trim_tunnel_outliers(
    lengths_min = 0,
    lengths_max = 3,
    widths_min = -0.4,
    widths_max = 0.8,
    heights_min = -0.2,
    heights_max = 0.5
  )
```

### Standardization of tunnel position and coordinates
The coordinate system of the tunnel itself may require adjustment or
standardization. For example, data collected across different days may show
slight differences in coordinate systems if calibration equipment was not used
in identical ways. Moreover, the user may want to redefine how the coorinate
system itself is defined (i.e. change the location of `(0, 0, 0)` to another
place within the tunnel.

pathviewR offers three main choices for such standardization:  

- `redefine_tunnel_center()`: Sets the location of 0 on any or all axes to a new
location. See the Help page for this function to see the four different methods
by which a user can specify this. No rotation of the tunnel is performed.  

- `standardize_tunnel()`: Use specified landmarks (`subjects` within the `viewr`
object) to rotate and translate the location of a tunnel, setting `(0, 0, 0)` to
the center of the tunnel (centering).

- `rotate_tunnel`:  Rotate and center a tunnel based on user-defined coordinates
(i.e. similar to `standardize_tunnel()` but for cases where specified landmarks
are not in the data).  

Two quick examples will follow, using our motive and Flydra data:

```{r rotate_example}
## Rotate and center the motive data set:
motive_rotated <-
  motive_trimmed %>% 
  rotate_tunnel(
    perch1_len_min = -0.06,
    perch1_len_max = 0.06,
    perch2_len_min = 2.48,
    perch2_len_max = 2.6,
    perch1_wid_min = 0.09,
    perch1_wid_max = 0.31,
    perch2_wid_min = 0.13,
    perch2_wid_max = 0.35
  )
```
In the above, virtual perches are defined by the user using the arguments shown.
The center of each perch is then found and then the locations of the two perch
centers are then used to 1) set  `(0, 0, 0)` to the point that is equidistant
from the perches (i.e. the middle of the tunnel) and 2) rotate the tunnel about
the height axis so that both perch width coordinates are at 0. This may be
easier to understand through plotting:
```{r rotate_example_plots}
## Quick (base-R) plot of the original data
plot(motive_trimmed$position_length,
     motive_trimmed$position_width,
     asp = 1)

## Quick (base-R) plot of the rotated data
plot(motive_rotated$position_length,
     motive_rotated$position_width,
     asp = 1)
```

Differences due to rotation may be extremely subtle, but the redefining of `(0,
0, 0)` to the middle of the tunnel should be clear from contrasting the axes of
the plots.

Flydra data typically do not need to be rotated, so we will instead use
`redfine_tunnel_center()` to adjust the location of `(0, 0, 0)`:

```{r redefine_tunnel_example}
## Re-center the Flydra data set:
flydra_centered <-
  flydra_data %>%
  redefine_tunnel_center(length_method = "middle",
                         height_method = "user-defined",
                         height_zero = 1.44)
```

Here, we are using `length_method = "middle"` to use the middle of the range of
"length" data to set length = 0 (a translation), making no change to the width
axis, and then specifiying that height = 0 should be equal to the value `1.44`
from the original data (another translation. Again, plotting may help; note that this time, we'll plot length x height (instead of width):

```{r redefine_example_plots}
## Quick (base-R) plot of the original data
plot(flydra_data$position_length,
     flydra_data$position_height,
     asp = 1)

## Quick (base-R) plot of the redefined data
plot(flydra_centered$position_length,
     flydra_centered$position_height,
     asp = 1)
```

Next sections TBD: 
x 1) rotate vs. standardize vs. redefine center
2) select x percent 
3) separate trajectories (and link to another vignette)
4) get full trajectories
